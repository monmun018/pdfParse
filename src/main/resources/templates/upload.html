<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Suica PDF Viewer</title>
    <link rel="stylesheet" th:href="@{/css/base.css}"/>
    <link rel="stylesheet" th:href="@{/css/app.css}"/>
</head>
<body class="page">
<header class="site-header">
    <div class="container header-inner">
        <div class="brand">
            <span>Suica PDF Viewer</span>
            <span class="badge">Beta</span>
        </div>
        <button class="nav-toggle" type="button" aria-label="Toggle navigation" id="navToggle">☰</button>
        <nav class="nav-links" id="navLinks" aria-label="Primary navigation">
            <a href="/">Upload</a>
        </nav>
    </div>
</header>

<main class="container">
    <section class="hero">
        <h1>モバイル Suica 残高ご利用明細</h1>
        <p>Upload your Mobile Suica history PDF to extract metadata and rows, then export the selection to CSV.</p>
    </section>

    <section class="card">
        <h2>Upload</h2>
        <div class="stack">
            <form method="post" action="/extract" enctype="multipart/form-data" class="stack">
                <div>
                    <label for="file">Choose Suica PDF</label>
                    <input id="file" type="file" name="file" accept="application/pdf" required/>
                </div>
                <fieldset class="feature-options">
                    <legend>Select features</legend>
                    <div class="feature-option" th:each="feature : ${availableFeatures}">
                        <input type="checkbox"
                               name="features"
                               th:id="${'feature-' + feature.name()}"
                               th:value="${feature.name()}"
                               th:checked="${selectedFeatures != null ? selectedFeatures.contains(feature) : true}"/>
                        <label th:for="${'feature-' + feature.name()}"
                               th:text="${T(com.example.demo.domain.model.PdfFeature).toDisplayName(feature)}">Feature</label>
                    </div>
                </fieldset>
                <button class="btn btn-primary" type="submit">Parse PDF</button>
            </form>

            <div class="error" th:if="${error}" th:text="${error}"></div>

            <section th:if="${result}" class="stack">
                <div class="card">
                    <div class="table-controls" style="margin-bottom: 0.75rem">
                        <h3 th:text="${result.fileName()}">Uploaded statement</h3>
                        <span class="tag"
                              th:text="${result.pdfType() == T(com.example.demo.domain.model.SuicaPdfType).PARTIAL_SELECTION ? 'Partial selection (amount only)' : 'Full history'}">
                            Full history
                        </span>
                    </div>
                    <div class="metadata-grid">
                        <div class="metadata-item">
                            <strong>Heading</strong>
                            <div th:text="${result.metadata()?.heading()}">モバイル Ｓｕｉｃａ 残高ご利用明細</div>
                        </div>
                        <div class="metadata-item">
                            <strong>Card</strong>
                            <div th:text="${result.metadata()?.cardNumberLine()}">JE*** **** **** 3963</div>
                        </div>
                        <div class="metadata-item">
                            <strong>History summary</strong>
                            <div th:text="${result.metadata()?.historySummary()}">残高履歴 （101件）</div>
                        </div>
                        <div class="metadata-item">
                            <strong>Created</strong>
                            <div th:text="${result.metadata()?.createdLine()}">2025/11/15 ...</div>
                        </div>
                        <div class="metadata-item">
                            <strong>Total pages</strong>
                            <div th:text="${result.pageCount()}">2</div>
                        </div>
                    </div>
                </div>

                <section class="card" th:if="${result.documentMetadata() != null}">
                    <h3>PDF Document Metadata</h3>
                    <div class="metadata-grid">
                        <div class="metadata-item">
                            <strong>PDF version</strong>
                            <div th:text="${result.documentMetadata().pdfVersion()}">1.4</div>
                        </div>
                        <div class="metadata-item">
                            <strong>Encrypted?</strong>
                            <div th:text="${result.documentMetadata().encrypted()} ? 'Yes' : 'No'">No</div>
                        </div>
                        <div class="metadata-item">
                            <strong>File size</strong>
                            <div th:text="${result.documentMetadata().fileSizeBytes()} + ' bytes'">0 bytes</div>
                        </div>
                    </div>

                    <div th:if="${result.documentMetadata().infoDictionary() != null}">
                        <h4>Info Dictionary</h4>
                        <div class="metadata-grid">
                            <div class="metadata-item">
                                <strong>Title</strong>
                                <div th:text="${result.documentMetadata().infoDictionary().title()}">Title</div>
                            </div>
                            <div class="metadata-item">
                                <strong>Author</strong>
                                <div th:text="${result.documentMetadata().infoDictionary().author()}">Author</div>
                            </div>
                            <div class="metadata-item">
                                <strong>Subject</strong>
                                <div th:text="${result.documentMetadata().infoDictionary().subject()}">Usage</div>
                            </div>
                            <div class="metadata-item">
                                <strong>Keywords</strong>
                                <div th:text="${result.documentMetadata().infoDictionary().keywords()}">Keywords</div>
                            </div>
                            <div class="metadata-item">
                                <strong>Creator</strong>
                                <div th:text="${result.documentMetadata().infoDictionary().creator()}">Creator</div>
                            </div>
                            <div class="metadata-item">
                                <strong>Producer</strong>
                                <div th:text="${result.documentMetadata().infoDictionary().producer()}">Producer</div>
                            </div>
                            <div class="metadata-item">
                                <strong>Created</strong>
                                <div th:text="${result.documentMetadata().infoDictionary().creationDate()}">2024-01-01</div>
                            </div>
                            <div class="metadata-item">
                                <strong>Modified</strong>
                                <div th:text="${result.documentMetadata().infoDictionary().modificationDate()}">2024-01-02</div>
                            </div>
                            <div class="metadata-item">
                                <strong>Trapped</strong>
                                <div th:text="${result.documentMetadata().infoDictionary().trapped()}">False</div>
                            </div>
                        </div>
                    </div>

                    <div th:if="${result.documentMetadata().xmpMetadata() != null}">
                        <h4>XMP Metadata</h4>
                        <div class="metadata-grid">
                            <div class="metadata-item">
                                <strong>Dublin Core Title</strong>
                                <div th:text="${result.documentMetadata().xmpMetadata().dublinCoreTitle()}">Title</div>
                            </div>
                            <div class="metadata-item">
                                <strong>Creators</strong>
                                <div th:text="${result.documentMetadata().xmpMetadata().dublinCoreCreators()}">Creator</div>
                            </div>
                            <div class="metadata-item">
                                <strong>Dates</strong>
                                <div th:text="${result.documentMetadata().xmpMetadata().dublinCoreDates()}">Date</div>
                            </div>
                            <div class="metadata-item">
                                <strong>Create Date</strong>
                                <div th:text="${result.documentMetadata().xmpMetadata().createDate()}">2025-01-01</div>
                            </div>
                            <div class="metadata-item">
                                <strong>Creator Tool</strong>
                                <div th:text="${result.documentMetadata().xmpMetadata().creatorTool()}">Tool</div>
                            </div>
                            <div class="metadata-item">
                                <strong>Metadata Date</strong>
                                <div th:text="${result.documentMetadata().xmpMetadata().metadataDate()}">2025-01-02</div>
                            </div>
                        </div>
                    </div>
                </section>

                <details class="raw-text-panel" th:if="${result.extractedText() != null}" open>
                    <summary>Raw Document Text</summary>
                    <pre class="raw-text" th:text="${result.extractedText()}">Raw PDF text will appear here</pre>
                </details>

                <form method="post" action="/export" id="csvForm" th:if="${#lists.size(result.rows()) > 0}" class="card stack">
                    <div class="table-controls">
                        <div>
                            <strong th:text="${#lists.size(result.rows())}">0</strong> rows detected
                            <span class="hint" th:if="${result.pdfType() == T(com.example.demo.domain.model.SuicaPdfType).PARTIAL_SELECTION}">
                                Balance is not present in this partial-selection PDF.
                            </span>
                        </div>
                        <div class="pagination">
                            <button class="btn btn-secondary" type="button" id="prevPage">Prev</button>
                            <span id="pageInfo" class="hint">Page 1 / 1</span>
                            <button class="btn btn-secondary" type="button" id="nextPage">Next</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="transactionsTable">
                            <thead>
                            <tr>
                                <th class="checkbox-col">
                                    <input type="checkbox" id="selectAll"/>
                                </th>
                                <th>月</th>
                                <th>日</th>
                                <th>種別 (入)</th>
                                <th>利用駅 (入)</th>
                                <th>種別 (出)</th>
                                <th>利用駅 (出)</th>
                                <th>残高</th>
                                <th>入金・利用金額</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="row : ${result.rows()}">
                                <td class="checkbox-col">
                                    <input type="checkbox" name="rowIds" th:value="${row.rowNumber()}"/>
                                </td>
                                <td th:text="${row.month()}">10</td>
                                <td th:text="${row.day()}">21</td>
                                <td th:text="${row.typeIn()}">入</td>
                                <td th:text="${row.stationIn()}">登戸</td>
                                <td th:text="${row.typeOut()}">出</td>
                                <td th:text="${row.stationOut()}">新宿</td>
                                <td th:text="${row.balance()}">¥1,359</td>
                                <td th:text="${row.amount()}">¥1,000</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <button class="btn btn-primary" id="exportBtn" type="submit" disabled>Export CSV</button>
                </form>
            </section>
        </div>
    </section>
</main>

<footer class="footer">
    <div class="container">
        Built for Mobile Suica history parsing. Keep your PDFs private—processing happens on upload only.
    </div>
</footer>

<script th:src="@{/js/app.js}"></script>
</body>
</html>
